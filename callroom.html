<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Call Room</title>
  <style>
    body {
      margin: 0;
      background: #000;
      display: flex;
      flex-direction: column;
      height: 100vh;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    header {
      padding: 10px;
      background: rgba(0,0,0,0.6);
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }
    #videos {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    video {
      background: #333;
      border-radius: 10px;
    }
    #localVideo {
      width: 35%;
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 2;
      transform: scaleX(-1);
    }
    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
    }
    footer {
      padding: 10px;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
    }
    .end {
      background: red;
      color: #fff;
    }
    .mute {
      background: #444;
      color: #fff;
    }
  </style>
</head>
<body>
  <header id="usernameDisplay">Connecting‚Ä¶</header>
  <div id="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <footer>
    <button class="mute" id="toggleMuteBtn">üîá</button>
    <button class="end" id="endCallBtn">üìû</button>
  </footer>

  <!-- ‚úÖ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    // üß© Your Firebase Config (replace with your actual values)
    const firebaseConfig = {
    apiKey: "AIzaSyD9dwHPDTJr1-mFXPW_JZnVS-JyZ6BNMgU",
    authDomain: "smart-waste-66279.firebaseapp.com",
    projectId: "smart-waste-66279",
    storageBucket: "smart-waste-66279.appspot.com",
    messagingSenderId: "619099585646",
    appId: "1:619099585646:web:b193d2a9fc13347d88ba7f"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const callId = params.get('callId');
    const role = params.get('role'); // caller or callee
    const otherUser = params.get('user') || "Unknown User";
    const usernameDisplay = document.getElementById('usernameDisplay');
    usernameDisplay.textContent = `Calling ${otherUser}‚Ä¶`;

    if (!callId || !role) {
      document.body.innerHTML = '<h2 style="color:white;text-align:center;margin-top:30px;">‚ùå Invalid or expired call link.</h2>';
      throw new Error("Missing callId or role");
    }

    let localStream;
    let remoteStream;
    let pc;

    const servers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    async function initMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
      } catch (err) {
        console.error("Media error:", err);
        alert("Camera/microphone access is required.");
      }
    }

    async function initCall() {
      pc = new RTCPeerConnection(servers);
      remoteStream = new MediaStream();
      document.getElementById('remoteVideo').srcObject = remoteStream;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
      };

      // ICE candidates
      const callDoc = db.collection('calls').doc(callId);
      const offerCandidates = callDoc.collection('offerCandidates');
      const answerCandidates = callDoc.collection('answerCandidates');

      pc.onicecandidate = event => {
        if (event.candidate) {
          const candidate = event.candidate.toJSON();
          const collection = (role === 'caller') ? offerCandidates : answerCandidates;
          collection.add(candidate);
        }
      };

      if (role === 'caller') {
        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);
        const offer = {
          sdp: offerDescription.sdp,
          type: offerDescription.type,
        };
        await callDoc.set({ offer });

        // Listen for answer
        callDoc.onSnapshot(snapshot => {
          const data = snapshot.data();
          if (!pc.currentRemoteDescription && data?.answer) {
            const answerDescription = new RTCSessionDescription(data.answer);
            pc.setRemoteDescription(answerDescription);
          }
        });

        // Listen for answer ICE
        answerCandidates.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const candidate = new RTCIceCandidate(change.doc.data());
              pc.addIceCandidate(candidate);
            }
          });
        });

      } else if (role === 'callee') {
        const callData = (await callDoc.get()).data();
        if (!callData || !callData.offer) {
          alert("No active call found.");
          window.close();
          return;
        }

        const offerDescription = callData.offer;
        await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);

        const answer = {
          type: answerDescription.type,
          sdp: answerDescription.sdp,
        };
        await callDoc.update({ answer });

        // Listen for caller ICE
        offerCandidates.onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const candidate = new RTCIceCandidate(change.doc.data());
              pc.addIceCandidate(candidate);
            }
          });
        });
      }
    }

    document.getElementById('toggleMuteBtn').onclick = () => {
      if (!localStream) return;
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      document.getElementById('toggleMuteBtn').textContent = audioTrack.enabled ? 'üîá' : 'üîä';
    };

    document.getElementById('endCallBtn').onclick = async () => {
      if (pc) pc.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      // Clean up Firestore
      await db.collection('calls').doc(callId).delete();
      window.close();
    };

    // Start flow
    initMedia().then(initCall);
  </script>
</body>
</html>