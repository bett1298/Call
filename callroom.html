<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Call Room</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    height: 100%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  header {
    text-align: center;
    padding: 10px;
    background: rgba(0,0,0,0.6);
    font-size: 18px;
    font-weight: 600;
  }
  .video-container {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    background: #000;
  }
  video {
    background: #000;
    border-radius: 10px;
    object-fit: cover;
  }
  #localVideo {
    position: absolute;
    width: 150px;
    height: 200px;
    bottom: 10px;
    right: 10px;
    border: 2px solid #fff;
  }
  #remoteVideo {
    width: 100%;
    height: 100%;
  }
  .controls {
    padding: 10px;
    text-align: center;
    background: rgba(0,0,0,0.6);
  }
  .controls button {
    background: red;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 50px;
    cursor: pointer;
  }
  .controls button:hover {
    background: #c00;
  }
</style>
</head>
<body>

<header id="callHeader">Connecting...</header>

<div class="video-container">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<div class="controls">
  <button id="endCallBtn">End Call</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

// ðŸ”¹ Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyD9dwHPDTJr1-mFXPW_JZnVS-JyZ6BNMgU",
    authDomain: "smart-waste-66279.firebaseapp.com",
    projectId: "smart-waste-66279",
    storageBucket: "smart-waste-66279.appspot.com",
    messagingSenderId: "619099585646",
    appId: "1:619099585646:web:b193d2a9fc13347d88ba7f"
  };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ðŸ”¹ Read URL params
const params = new URLSearchParams(window.location.search);
const callId = params.get('callId');
const role = params.get('role'); // 'caller' or 'callee'
const callType = params.get('type'); // 'voice' or 'video'

const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const header = document.getElementById('callHeader');

let localStream, peerConnection;
const callDoc = doc(db, "calls", callId);
const offerCandidates = collection(callDoc, "offerCandidates");
const answerCandidates = collection(callDoc, "answerCandidates");
const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

// ðŸ”¹ Start preview immediately (WhatsApp style)
async function startPreview() {
  const constraints = callType === 'video' ? { video: true, audio: true } : { audio: true };
  localStream = await navigator.mediaDevices.getUserMedia(constraints);
  localVideo.srcObject = localStream;
}

// ðŸ”¹ Initialize WebRTC call
async function initCall() {
  await startPreview();

  peerConnection = new RTCPeerConnection(servers);
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  peerConnection.ontrack = e => remoteVideo.srcObject = e.streams[0];

  peerConnection.onicecandidate = async (event) => {
    if (event.candidate) {
      const targetCollection = role === 'caller' ? offerCandidates : answerCandidates;
      await addDoc(targetCollection, event.candidate.toJSON());
    }
  };

  // ðŸ”¹ Ringtone sound
  const ringtone = new Audio('https://actions.google.com/sounds/v1/alarms/phone_alerts.ogg');
  ringtone.loop = true;

  if (role === 'caller') {
    const offerDescription = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offerDescription);
    await updateDoc(callDoc, { offer: offerDescription, status: 'ringing' });
    ringtone.play();

    onSnapshot(callDoc, snapshot => {
      const data = snapshot.data();
      if (data?.status === 'accepted' || data?.status === 'rejected') ringtone.pause();
      if (data?.answer && !peerConnection.currentRemoteDescription) {
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    onSnapshot(answerCandidates, snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });

  } else {
    ringtone.play();
    onSnapshot(callDoc, async snapshot => {
      const data = snapshot.data();
      if (data?.offer && !peerConnection.currentRemoteDescription) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answerDescription = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answerDescription);
        await updateDoc(callDoc, { answer: answerDescription, status: 'accepted' });
        ringtone.pause();
      }
    });

    onSnapshot(offerCandidates, snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });
  }

  header.innerText = `Call (${callType}) - ${role === 'caller' ? 'Calling...' : 'Incoming...'}`;

  // ðŸ”¹ End call detection
  onSnapshot(callDoc, snapshot => {
    const data = snapshot.data();
    if (data?.status === 'ended') endCall();
  });
}

// ðŸ”¹ End call
async function endCall() {
  try { await updateDoc(callDoc, { status: 'ended' }); } catch(e){}
  if (peerConnection) peerConnection.close();
  if (localStream) localStream.getTracks().forEach(track => track.stop());
  window.close();
}

document.getElementById('endCallBtn').onclick = endCall;

// ðŸ”¹ Start
document.addEventListener('DOMContentLoaded', initCall);

</script>
</body>
</html>