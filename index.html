<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receiver Page</title>
<style>
body { margin:0; padding:0; font-family:Arial; background:#111; color:#fff; }
#localVideo { position:fixed; bottom:20px; right:20px; width:120px; height:160px; border:2px solid #25D366; border-radius:12px; object-fit:cover; display:none; }
</style>
</head>
<body>

<video id="localVideo" autoplay muted playsinline></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

// ---------------- Firebase Setup ----------------
const firebaseConfig = {
    apiKey: "AIzaSyD9dwHPDTJr1-mFXPW_JZnVS-JyZ6BNMgU",
    authDomain: "smart-waste-66279.firebaseapp.com",
    projectId: "smart-waste-66279",
    storageBucket: "smart-waste-66279.appspot.com",
    messagingSenderId: "619099585646",
    appId: "1:619099585646:web:b193d2a9fc13347d88ba7f"
  };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------------- User ID ----------------
const currentUserId = "USER_B_ID"; // receiver's ID

// ---------------- Video ----------------
const localVideo = document.getElementById('localVideo');
let localStream, peerConnection;

// ---------------- Listen for Incoming Calls ----------------
function listenForIncomingCalls() {
  const q = query(
    collection(db, "calls"),
    where("toId","==",currentUserId),
    where("status","==","ringing")
  );

  onSnapshot(q, snapshot => {
    snapshot.docChanges().forEach(change => {
      if(change.type === "added"){
        const callData = change.doc.data();
        showIncomingCallPopup(callData, change.doc.id);
      }
    });
  });
}

// ---------------- Show Popup ----------------
function showIncomingCallPopup(callData, callId) {
  // Ringing sound
  const audio = new Audio('https://actions.google.com/sounds/v1/alarms/phone_alerts.ogg');
  audio.loop = true;
  audio.play().catch(()=>console.log('Audio blocked'));

  // Popup
  const popup = document.createElement('div');
  popup.style.cssText = `
    position:fixed; top:20px; right:20px; background:#fff; color:#000;
    padding:15px; border:2px solid #25D366; border-radius:10px; z-index:9999;
  `;
  popup.innerHTML = `
    <strong>Incoming ${callData.type} call from ${callData.fromId}</strong>
    <br><br>
    <button class="acceptBtn">Accept</button>
    <button class="rejectBtn">Reject</button>
  `;
  document.body.appendChild(popup);

  const stopAlerts = () => audio.pause();

  // Accept
  popup.querySelector(".acceptBtn").onclick = async () => {
    stopAlerts();
    localVideo.style.display = "block";
    localStream = await navigator.mediaDevices.getUserMedia({ video: callData.type==='video', audio:true });
    localVideo.srcObject = localStream;

    await updateDoc(doc(db, "calls", callId), { status:"accepted" });

    startWebRTC(localStream, callId, 'callee', callData.type);
    popup.remove();
  };

  // Reject
  popup.querySelector(".rejectBtn").onclick = async () => {
    stopAlerts();
    await updateDoc(doc(db,"calls",callId), { status:"rejected" });
    popup.remove();
  };
}

// ---------------- WebRTC ----------------
async function startWebRTC(localStream, callId, role, callType) {
  const callDoc = doc(db,"calls",callId);
  const offerCandidates = collection(callDoc,"offerCandidates");
  const answerCandidates = collection(callDoc,"answerCandidates");

  peerConnection = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  localStream.getTracks().forEach(track=>peerConnection.addTrack(track,localStream));

  peerConnection.ontrack = e => { 
    let remoteVideo = document.getElementById('remoteVideo');
    if(!remoteVideo){
      remoteVideo = document.createElement('video');
      remoteVideo.id='remoteVideo';
      remoteVideo.autoplay=true;
      remoteVideo.playsInline=true;
      remoteVideo.style.cssText="width:100%; height:100%; object-fit:cover; position:fixed; top:0; left:0; z-index:0;";
      document.body.appendChild(remoteVideo);
    }
    remoteVideo.srcObject = e.streams[0]; 
  };

  peerConnection.onicecandidate = async e => {
    if(!e.candidate) return;
    const target = role==='callee' ? answerCandidates : offerCandidates;
    await addDoc(target, e.candidate.toJSON());
  };

  // Set remote description
  const snap = await callDoc.get();
  const offerData = (await snap.data()).offer;
  await peerConnection.setRemoteDescription(new RTCSessionDescription(offerData));

  // Create answer
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  await updateDoc(callDoc,{answer:answer.toJSON(), status:'in-call'});

  // Listen for ICE from caller
  onSnapshot(offerCandidates, snap => {
    snap.docChanges().forEach(change=>{
      if(change.type==='added') peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
    });
  });

  console.log("Call connected!");
}

// ---------------- Start Listening ----------------
listenForIncomingCalls();
</script>
</body>
</html>
