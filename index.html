<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DateLink ‚Äî Chats</title>
  <style>
    :root {
      --primary: #6C63FF;
      --primary-light: #8A84FF;
      --primary-dark: #5651D9;
      --secondary: #FF6584;
      --background: #F9F9FF;
      --surface: #FFFFFF;
      --on-surface: #333333;
      --on-surface-light: #777777;
      --border: #EEEEF5;
      --shadow: 0 4px 12px rgba(108, 99, 255, 0.08);
      --radius: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--background);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: var(--on-surface);
      line-height: 1.5;
    }

    nav {
      background: var(--surface);
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%;
      display: flex; 
      justify-content: space-around; 
      align-items: center;
      height: 60px; 
      box-shadow: var(--shadow);
      z-index: 100;
      padding: 0 16px;
    }

    nav a {
      text-decoration: none;
      color: var(--on-surface-light);
      font-weight: 500;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    nav a:hover, nav a.active {
      color: var(--primary);
      background: rgba(108, 99, 255, 0.05);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin-top: 60px;
      overflow: hidden;
    }

    /* Current user info bar */
    .current-user {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: relative;
    }

    .current-user img {
      width: 44px; 
      height: 44px; 
      border-radius: 50%;
      object-fit: cover; 
      border: 2px solid var(--primary); 
      margin-right: 12px;
    }

    .current-user .user-info {
      flex: 1;
    }

    .current-user .user-info strong {
      font-weight: 600;
      display: block;
      font-size: 16px;
    }

    .current-user .user-info small {
      color: var(--on-surface-light);
      font-size: 13px;
    }

    .current-user .dot {
      width: 10px; 
      height: 10px; 
      border-radius: 50%;
      background: #4caf50; 
      position: absolute;
      left: 48px; 
      bottom: 20px; 
      border: 2px solid var(--surface);
    }

    /* Search Bar */
    .search-bar {
      background: var(--surface);
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
    }

    .search-bar .search-container {
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 12px 16px 12px 40px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-family: inherit;
      background: var(--background);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    .search-bar .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--on-surface-light);
    }

    /* Horizontal active users */
    .user-scroll {
      display: flex;
      overflow-x: auto;
      padding: 16px 20px;
      gap: 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      scrollbar-width: thin;
    }

    .user-scroll::-webkit-scrollbar {
      height: 4px;
    }

    .user-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
    }

    .user-item {
      flex: 0 0 auto;
      display: flex; 
      flex-direction: column; 
      align-items: center;
      cursor: pointer; 
      transition: all 0.2s ease;
      border-radius: var(--radius); 
      padding: 8px; 
      position: relative;
      min-width: 68px;
    }

    .user-item:hover { 
      background: rgba(108, 99, 255, 0.05); 
    }

    .user-item.active {
      background: rgba(108, 99, 255, 0.1);
    }

    .user-item img {
      width: 56px; 
      height: 56px; 
      border-radius: 50%;
      object-fit: cover; 
      border: 2px solid var(--primary); 
      margin-bottom: 6px;
    }

    .user-item strong {
      font-size: 12px;
      text-align: center;
      white-space: nowrap;
      max-width: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
    }

    .online-dot {
      width: 10px; 
      height: 10px; 
      border-radius: 50%;
      background: #4caf50; 
      position: absolute;
      right: 10px; 
      bottom: 28px; 
      border: 2px solid var(--surface);
    }

    .notif-dot {
      width: 10px; 
      height: 10px; 
      border-radius: 50%;
      background: var(--secondary); 
      position: absolute;
      right: 8px; 
      top: 8px; 
      border: 2px solid var(--surface);
    }

    /* Chat Box */
    .chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--surface);
      height: 100%;
      overflow: hidden;
    }

    .chat-header {
      display: flex; 
      align-items: center; 
      padding: 16px 20px; 
      background: var(--surface); 
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .chat-header img { 
      width: 44px; 
      height: 44px; 
      border-radius: 50%; 
      object-fit: cover; 
      margin-right: 12px; 
      border: 2px solid var(--primary);
    }

    .chat-header .user-info {
      flex: 1;
    }

    .chat-header .user-info h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .chat-header .user-info p {
      margin: 0;
      font-size: 13px;
      color: var(--on-surface-light);
    }

    .chat-header .actions {
      display: flex;
      gap: 12px;
    }

    .chat-header .action-btn {
      background: none;
      border: none;
      color: var(--on-surface-light);
      font-size: 18px;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .chat-header .action-btn:hover {
      background: rgba(108, 99, 255, 0.05);
      color: var(--primary);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
      background: #F5F7FB;
    }

    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 10px;
    }

    .message {
      padding: 12px 16px;
      border-radius: var(--radius);
      margin: 4px 0;
      max-width: 75%;
      word-wrap: break-word;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sent {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: var(--radius-sm);
    }

    .received {
      align-self: flex-start;
      background: var(--surface);
      color: var(--on-surface);
      border-bottom-left-radius: var(--radius-sm);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }

    .received .message-time {
      text-align: left;
    }

    .input-area {
      display: flex; 
      padding: 16px 20px; 
      border-top: 1px solid var(--border); 
      align-items: center; 
      background: var(--surface);
      gap: 12px;
    }

    .input-area .input-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-area input {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      font-family: inherit;
      background: var(--background);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .input-area input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.1);
    }

    .input-area .action-btn {
      background: none;
      border: none;
      color: var(--on-surface-light);
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input-area .action-btn:hover {
      background: rgba(108, 99, 255, 0.05);
      color: var(--primary);
    }

    .input-area .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .input-area .send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    .placeholder {
      text-align: center;
      margin: auto;
      color: var(--on-surface-light);
      padding: 40px 20px;
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .placeholder h3 {
      margin: 0 0 8px 0;
      font-weight: 600;
      font-size: 18px;
    }

    .placeholder p {
      margin: 0;
      font-size: 14px;
    }

    #mediaInput { display: none; }

    /* Message options */
    .message-options {
      display: flex;
      gap: 12px;
      margin-top: 8px;
      font-size: 12px;
    }

    .message-options button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .message-options button:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1);
    }

    .received .message-options button:hover {
      background: rgba(108, 99, 255, 0.05);
    }

    @media (max-width: 600px) {
      .user-item img { width: 52px; height: 52px; }
      .chat-header h3 { font-size: 16px; }
      .input-area input { font-size: 14px; }
      .message {
        max-width: 85%;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="home2.html">
      <span>üè†</span>
      <span>Home</span>
      
      
    </a>
    <a href="matchs.html">
      <span>üíû</span>
      <span>Match</span>
    </a>
    <a href="chats.html" class="active">
      <span>üí¨</span>
      <span>Chats</span>
    </a>
    <a href="profile.html">
      <span>üë§</span>
      <span>Profile</span>
    </a>
  </nav>

  <div class="chat-container">
    <div class="current-user" id="currentUserInfo">
      <img id="currentUserPhoto" src="https://via.placeholder.com/50" alt="you">
      <div class="user-info">
        <strong id="currentUserName">Loading...</strong>
        <small id="currentUserStatus">Online</small>
      </div>
      <div class="dot" id="currentUserDot" style="display:none;"></div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <div class="search-container">
        <div class="search-icon">üîç</div>
        <input id="searchInput" placeholder="Search users...">
      </div>
    </div>

    <div class="user-scroll" id="userList"></div>

    <div class="chat-box" id="chatBox">
      <div class="placeholder">
        <div class="placeholder-icon">üí¨</div>
        <h3>Start a conversation</h3>
        <p>Select a user to start chatting</p>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
  // All the original JavaScript code remains exactly the same
  const firebaseConfig = {
    apiKey: "AIzaSyD9dwHPDTJr1-mFXPW_JZnVS-JyZ6BNMgU",
    authDomain: "smart-waste-66279.firebaseapp.com",
    projectId: "smart-waste-66279",
    storageBucket: "smart-waste-66279.appspot.com",
    messagingSenderId: "619099585646",
    appId: "1:619099585646:web:b193d2a9fc13347d88ba7f"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const userList = document.getElementById('userList');
  const searchInput = document.getElementById('searchInput');
  const chatBox = document.getElementById('chatBox');

  let currentUserId = null;
  let activeUserId = null;
  let unsubscribeMessages = null;
  let allUsers = [];

  auth.onAuthStateChanged(async (user) => {
    if (!user) return (window.location.href = 'login.html');
    currentUserId = user.uid;

    const uRef = db.collection('users').doc(currentUserId);
    const uSnap = await uRef.get();
    if (!uSnap.exists) {
      await uRef.set({
        fullName: user.displayName || 'You',
        photoURL: user.photoURL || '',
        online: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    const data = (await uRef.get()).data();
    document.getElementById('currentUserPhoto').src = data.photoURL || 'https://via.placeholder.com/50';
    document.getElementById('currentUserName').textContent = data.fullName || 'You';
    document.getElementById('currentUserDot').style.display = data.online ? 'block' : 'none';

    setUserOnline(true);
    window.addEventListener("beforeunload", () => setUserOnline(false));

    loadUsers();
    listenForIncomingMessages();

    // ‚úÖ Auto open chat if ?uid= param is present
    const params = new URLSearchParams(window.location.search);
    const targetUid = params.get('uid');
    if (targetUid) {
      const targetDoc = await db.collection('users').doc(targetUid).get();
      if (targetDoc.exists) openChat(targetUid, targetDoc.data());
    }
  });

  function setUserOnline(status) {
    if (!currentUserId) return;
    db.collection('users').doc(currentUserId).set({
      online: status,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  }

  function loadUsers() {
    db.collection('users').onSnapshot(snapshot => {
      allUsers = [];
      userList.innerHTML = '';
      snapshot.forEach(doc => {
        if (doc.id === currentUserId) return;
        const u = { id: doc.id, ...doc.data() };
        allUsers.push(u);
      });
      renderUsers(allUsers);
    });
  }

  // ‚úÖ Filter users
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    const filtered = allUsers.filter(u => (u.fullName || '').toLowerCase().includes(term));
    renderUsers(filtered);
  });

  function renderUsers(users) {
    userList.innerHTML = '';
    users.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.setAttribute('data-id', u.id);
      div.innerHTML = `
        <img src="${u.photoURL || 'https://via.placeholder.com/50'}">
        <strong>${u.fullName || 'User'}</strong>
        ${u.online ? '<div class="online-dot"></div>' : ''}
      `;
      div.addEventListener('click', () => openChat(u.id, u));
      userList.appendChild(div);
    });
  }

  function chatIdFor(a, b) { return [a, b].sort().join('_'); }

  async function openChat(userId, user) {
    activeUserId = userId;
    const chatId = chatIdFor(currentUserId, userId);
    clearNotifDot(userId);
    
    // Remove active class from all users
    document.querySelectorAll('.user-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // Add active class to selected user
    const activeUser = document.querySelector(`.user-item[data-id="${userId}"]`);
    if (activeUser) activeUser.classList.add('active');

    chatBox.innerHTML = `
      <div class="chat-header">
        <img src="${user.photoURL || 'https://via.placeholder.com/50'}">
        <div class="user-info">
          <h3>${user.fullName || 'User'}</h3>
          <p>${user.online ? 'Online' : 'Offline'}</p>
        </div>
        <div class="actions">
        <span class="call-btn">üìû</span>
          
          <button class="action-btn">‚ãÆ</button>
        </div>
        ${user.online ? '<div class="online-dot"></div>' : ''}
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <div class="input-container">
          <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
        </div>
        <button class="action-btn" id="uploadBtn">üìé</button>
        <button class="send-btn" id="sendBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    `;

    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const callBtn = chatBox.querySelector('.actions .action-btn');
if (callBtn) {
  callBtn.addEventListener('click', () => {
    if (!activeUserId) return;
    startCall(activeUserId);
  });
}
// ‚úÖ CALL SETUP MENU ‚Äî Add this inside openChat(), after rendering chat header
const callButton = document.querySelector('.chat-header .call-btn'); // or adjust selector to match üìû button
if (callButton) {
  callButton.onclick = () => {
    // Remove existing menu if open
    const existingMenu = document.getElementById('callMenu');
    if (existingMenu) existingMenu.remove();

    // Create menu
    const menu = document.createElement('div');
    menu.id = 'callMenu';
    menu.style.position = 'fixed';
    menu.style.top = '50%';
    menu.style.left = '50%';
    menu.style.transform = 'translate(-50%, -50%)';
    menu.style.background = '#fff';
    menu.style.padding = '15px';
    menu.style.borderRadius = '10px';
    menu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    menu.style.zIndex = '9999';
    menu.style.textAlign = 'center';
    menu.innerHTML = `
      <p>Start a call with <strong>${user.fullName}</strong></p>
      <button id="voiceCallBtn" style="margin:5px; padding:8px 12px; background:#4CAF50; color:#fff; border:none; border-radius:5px;">üìû Voice</button>
      <button id="videoCallBtn" style="margin:5px; padding:8px 12px; background:#2196F3; color:#fff; border:none; border-radius:5px;">üìπ Video</button>
      <button id="cancelCallBtn" style="margin:5px; padding:8px 12px; background:#aaa; color:#fff; border:none; border-radius:5px;">Cancel</button>
    `;
    document.body.appendChild(menu);

    document.getElementById('voiceCallBtn').onclick = () => {
      startCall(userId, user.fullName, 'voice');
      menu.remove();
    };
    document.getElementById('videoCallBtn').onclick = () => {
      startCall(userId, user.fullName, 'video');
      menu.remove();
    };
    document.getElementById('cancelCallBtn').onclick = () => menu.remove();
  };
}
async function startCall(receiverId, receiverName, type) {
  const callId = Date.now().toString() + Math.random().toString(36).substring(2, 8);

  await db.collection('calls').doc(callId).set({
    callerId: currentUserId,
    calleeId: receiverId,
    type: type, // 'voice' or 'video'
    status: 'ringing',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // Open callroom page
  window.open(`callroom.html?callId=${callId}&role=caller&user=${encodeURIComponent(receiverName)}`, '_blank');
}
    // Add media input
    const mediaInput = document.createElement('input');
    mediaInput.type = 'file';
    mediaInput.id = 'mediaInput';
    mediaInput.accept = 'image/*,video/*';
    mediaInput.style.display = 'none';
    document.querySelector('.input-area').appendChild(mediaInput);
    
    uploadBtn.onclick = () => mediaInput.click();

    if (unsubscribeMessages) unsubscribeMessages();

    unsubscribeMessages = db.collection('messages')
      .where('chatId', '==', chatId)
      .onSnapshot(snapshot => {
        const msgs = [];
        snapshot.forEach(doc => msgs.push(doc.data()));
        msgs.sort((a,b) => (a.timestamp?.toMillis?.()||0) - (b.timestamp?.toMillis?.()||0));
        messagesDiv.innerHTML = '';
        msgs.forEach(msg => appendMessageElement(msg, messagesDiv));
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      await db.collection('messages').add({
        chatId, from: currentUserId, to: userId, text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    };
    
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendBtn.click();
      }
    });
  }

  function appendMessageElement(msg, container) {
    const div = document.createElement('div');
    div.className = 'message ' + (msg.from === currentUserId ? 'sent' : 'received');
    
    // Format timestamp
    const time = msg.timestamp ? 
      msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
      new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    if (msg.mediaUrl) {
      if (msg.mediaType === 'image') {
        div.innerHTML = `
          <img src="${msg.mediaUrl}" style="max-width:100%;border-radius:10px;display:block;">
          <div class="message-time">${time}</div>
        `;
      } else {
        div.innerHTML = `
          <video controls style="max-width:100%;border-radius:10px;display:block;">
            <source src="${msg.mediaUrl}">
          </video>
          <div class="message-time">${time}</div>
        `;
      }
    } else {
      div.innerHTML = `
        <div>${msg.text}</div>
        <div class="message-time">${time}</div>
      `;
    }
    
    // Add message options
    const options = document.createElement('div');
    options.className = 'message-options';
    options.innerHTML = `
      <button class="replyBtn">‚Ü© Reply</button>
      <button class="copyBtn">üìã Copy</button>
    `;
    
    options.querySelector('.replyBtn').onclick = () => {
      const input = document.getElementById('messageInput');
      input.value = `‚Ü© ${msg.text || '[media]'} `;
      input.focus();
    };
    
    options.querySelector('.copyBtn').onclick = () => {
      navigator.clipboard.writeText(msg.text || msg.mediaUrl || '');
      // Show a subtle notification instead of alert
      const notification = document.createElement('div');
      notification.textContent = 'Copied to clipboard';
      notification.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--primary); color:white; padding:8px 16px; border-radius:var(--radius); font-size:14px; z-index:1000;';
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 2000);
    };
    
    div.appendChild(options);
    container.appendChild(div);
    
    // Enable swipe to reply
    enableSwipeToReply(div, msg);
  }

  function enableSwipeToReply(msgDiv, msg) {
    let startX = 0;
    let currentX = 0;
    let swiping = false;

    msgDiv.addEventListener('touchstart', e => {
      if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        swiping = true;
        msgDiv.style.transition = '';
      }
    });

    msgDiv.addEventListener('touchmove', e => {
      if (!swiping) return;
      currentX = e.touches[0].clientX;
      const dx = currentX - startX;
      if (dx > 0) { // swipe right
        msgDiv.style.transform = `translateX(${Math.min(dx, 100)}px)`;
      }
    });

    msgDiv.addEventListener('touchend', e => {
      swiping = false;
      const dx = currentX - startX;
      if (dx > 60) { // threshold for swipe
        // trigger reply
        const input = document.getElementById('messageInput');
        input.value = `‚Ü© ${msg.text || '[media]'} `;
        input.focus();
      }
      // reset visual
      msgDiv.style.transition = 'transform 0.2s ease';
      msgDiv.style.transform = 'translateX(0)';
    });
  }

  function listenForIncomingMessages() {
  db.collection('messages')
    .where('to', '==', currentUserId)
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          if (msg.from !== activeUserId) {
            showNotifDot(msg.from); // existing red dot

            // üîî Browser notification
            if (Notification.permission === "granted") {
              const title = "New message from " + (msg.fromName || "Someone");
              const options = {
                body: msg.text || (msg.mediaType === 'image' ? "üì∑ Image" : "üé• Video"),
                icon: msg.fromPhoto || 'https://via.placeholder.com/50',
                tag: msg.chatId // ensures grouping
              };
              const notif = new Notification(title, options);

              // Clicking notification opens chat
              notif.onclick = () => {
                window.focus();
                openChat(msg.from, { fullName: msg.fromName, photoURL: msg.fromPhoto });
                notif.close();
              };
            }
          }
        }
      });
    });
}
function showNotifDot(userId) {
  const el = userList.querySelector(`.user-item[data-id="${userId}"]`);
  if (!el) return;

  // Increase unread count
  notifCounts[userId] = (notifCounts[userId] || 0) + 1;

  // Create dot if it doesn't exist
  let dot = el.querySelector('.notif-dot');
  if (!dot) {
    dot = document.createElement('div');
    dot.className = 'notif-dot';
    el.appendChild(dot);
  }

  // Show count with cap at 10+
  dot.textContent = notifCounts[userId] > 10 ? '10+' : notifCounts[userId];
  dot.style.display = 'flex';
  dot.style.justifyContent = 'center';
  dot.style.alignItems = 'center';
  dot.style.color = '#fff';
  dot.style.fontSize = '10px';
  dot.style.fontWeight = '600';
  dot.style.pointerEvents = 'none'; // ensures clicks go to user-item
}

// Call this when a chat is opened to reset count
function clearNotifDot(userId) {
  notifCounts[userId] = 0;
  const dot = userList.querySelector(`.user-item[data-id="${userId}"] .notif-dot`);
  if (dot) dot.style.display = 'none';
}
  function showNotifDot(userId) {
    const el = userList.querySelector(`.user-item[data-id="${userId}"]`);
    if (el && !el.querySelector('.notif-dot')) {
      const dot = document.createElement('div');
      dot.className = 'notif-dot';
      el.appendChild(dot);
    }
  }

  function clearNotifDot(userId) {
    const dot = userList.querySelector(`.user-item[data-id="${userId}"] .notif-dot`);
    if (dot) dot.remove();
  }
/* ============================
üìû STEP 1: CALL SIGNALING LOGIC
============================ */
const callsRef = db.collection('calls');

// ‚úÖ Listen for incoming calls automatically
auth.onAuthStateChanged(user => {
  if (!user) return;

  callsRef
    .where('receiver', '==', user.uid)
    .where('status', '==', 'ringing')
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const callId = change.doc.id;
          const data = change.doc.data();

          // prevent multiple call pages opening
          if (!window.callAlreadyOpened) {
            window.callAlreadyOpened = true;
            window.open(`callroom.html?id=${callId}&caller=false`, '_blank');
          }
        }
      });
    });
});

// ‚úÖ Start a call when üìû button clicked
function startCall(receiverId) {
  const callId = `${currentUserId}_${receiverId}`;
  callsRef.doc(callId).set({
    offer: null,
    answer: null,
    caller: currentUserId,
    receiver: receiverId,
    status: "ringing",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    window.open(`callroom.html?id=${callId}&caller=true`, '_blank');
  });
}
  /* ============================================
     ‚úÖ ENHANCED MEDIA UPLOAD WITH COMPRESSION
     ============================================ */
  async function compressImage(file, quality = 0.8, maxWidth = 1280, maxHeight = 1280) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = () => {
        let { width, height } = img;
        const scale = Math.min(maxWidth / width, maxHeight / height, 1);
        width *= scale; height *= scale;

        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob(
          (blob) => resolve(new File([blob], file.name, { type: 'image/jpeg' })),
          'image/jpeg',
          quality
        );
      };
    });
  }

  // Handle media upload
  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'mediaInput') {
      const file = e.target.files[0];
      if (!file || !activeUserId) return;
      const chatId = chatIdFor(currentUserId, activeUserId);
      const fileType = file.type.startsWith('image') ? 'image' : 'video';

      // Optional preview
      const preview = URL.createObjectURL(file);
      const input = document.getElementById('messageInput');
      input.placeholder = fileType === 'image' ? 'üì∑ Image selected...' : 'üé• Video selected...';

      // Reset input
      e.target.value = '';

      try {
        if (fileType === 'image') {
          // Compress image before upload
          compressImage(file, 0.8).then(compressed => {
            const formData = new FormData();
            formData.append('image', compressed);
            return fetch(`https://api.imgbb.com/1/upload?key=e26f20d023a0094ee31c68ded33ab41d`, {
              method: 'POST', body: formData
            });
          }).then(res => res.json()).then(data => {
            const url = data.data.url;
            return db.collection('messages').add({
              chatId, from: currentUserId, to: activeUserId,
              mediaUrl: url, mediaType: 'image',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
          }).then(() => {
            input.placeholder = 'Type a message...';
          });
        } else {
          // Video upload would go here
          // For now, we'll just show an alert
          alert('Video upload would be implemented here with Cloudinary or similar service');
          input.placeholder = 'Type a message...';
        }
      } catch (err) {
        alert('Upload failed: ' + err.message);
        input.placeholder = 'Type a message...';
      }
    }
  });
  </script>
  <script>
function listenForIncomingCalls(currentUserId) {
  db.collection('calls')
    .where('calleeId', '==', currentUserId)
    .where('status', '==', 'ringing')
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const call = change.doc.data();
          const callId = change.doc.id;

          const popup = document.createElement('div');
          popup.style.position = 'fixed';
          popup.style.top = '20px';
          popup.style.right = '20px';
          popup.style.background = '#fff';
          popup.style.padding = '15px';
          popup.style.borderRadius = '10px';
          popup.style.boxShadow = '0 2px 8px rgba(0,0,0,0.25)';
          popup.style.zIndex = '9999';
          popup.innerHTML = `
            <p>üìû Incoming ${call.type} call</p>
            <button id="acceptCall">Accept</button>
            <button id="rejectCall">Reject</button>
          `;
          document.body.appendChild(popup);

          document.getElementById('acceptCall').onclick = async () => {
            await db.collection('calls').doc(callId).update({ status: 'answered' });
            window.open(`callroom.html?callId=${callId}&role=callee`, '_blank');
            popup.remove();
          };

          document.getElementById('rejectCall').onclick = async () => {
            await db.collection('calls').doc(callId).update({ status: 'declined' });
            popup.remove();
          };
        }
      });
    });
}
</script>

</body>
</html>
